{% extends 'base.html' %}
{% load static %}

{% block content %}

<h1 class="mb-4">Sistema de Clientes</h1>
<p class="text-muted">Sistema de inventario por el Grupo 3</p>

<!-- ===== BOTÓN AGREGAR CLIENTE ===== -->
<div class="mb-3">
    <button type="button" class="btn btn-success" onclick="agregarCliente()">
        <i class="fa-solid fa-user-plus me-2"></i>Agregar Cliente
    </button>
</div>

<!-- ===== BÚSQUEDA Y FILTROS ===== -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="searchInputClientes" class="form-control" placeholder="Buscar cliente...">
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <label class="form-label">Filtrar por estado:</label>
                <select id="filtroEstado" class="form-select" style="max-width: 300px;">
                    <option value="all">Todos</option>
                    <option value="activo">Activos</option>
                    <option value="inactivo">Inactivos</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- ===== TABLA CLIENTES ===== -->
<div class="card mt-4">
    <div class="card-header bg-dark text-light">Clientes registrados</div>
    <div class="card-body">
        <table class="table table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Documento</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Dirección</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="clientesTabla"></tbody>
        </table>
    </div>
</div>

<script>
    const CSRF = '{{ csrf_token }}';
    let clientes = [];

    // ===== CARGAR CLIENTES DESDE LA BD =====
    function cargarClientes() {
        fetch('/clientes/json/')
            .then(r => r.json())
            .then(data => {
                clientes = data.clientes;
                renderizarClientes();
            })
            .catch(() => Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudieron cargar los clientes.' }));
    }

    // ===== RENDERIZAR TABLA =====
    function renderizarClientes() {
        const tbody = document.getElementById('clientesTabla');
        const busqueda = document.getElementById('searchInputClientes').value.toLowerCase();
        const filtro = document.getElementById('filtroEstado').value;

        let filtrados = clientes.filter(c => {
            const cumpleBusqueda = c.nombre.toLowerCase().includes(busqueda) ||
                                   c.documento.includes(busqueda) ||
                                   c.email.toLowerCase().includes(busqueda);
            const cumpleFiltro = filtro === 'all' || c.estado === filtro;
            return cumpleBusqueda && cumpleFiltro;
        });

        if (filtrados.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No se encontraron clientes</td></tr>`;
            return;
        }

        tbody.innerHTML = filtrados.map(c => `
            <tr>
                <td>${c.id}</td>
                <td>${c.nombre}</td>
                <td>${c.documento}</td>
                <td>${c.telefono}</td>
                <td>${c.email}</td>
                <td>${c.direccion}</td>
                <td>
                    <span class="badge ${c.estado === 'activo' ? 'bg-success' : 'bg-secondary'}">
                        ${c.estado === 'activo' ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="editarCliente(${c.id})">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarCliente(${c.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // ===== VALIDACIONES =====
    function soloNumeros(event) {
        const charCode = event.which ? event.which : event.keyCode;
        if (charCode === 8 || charCode === 9 || charCode === 27 || charCode === 13 ||
            (charCode >= 35 && charCode <= 40) || charCode === 46) return true;
        if (charCode < 48 || charCode > 57) { event.preventDefault(); return false; }
        return true;
    }

    function limpiarLetras(input) {
        input.value = input.value.replace(/[^\d]/g, '');
    }

    function aplicarValidacionesNumericas() {
        setTimeout(() => {
            ['swal-documento', 'swal-telefono'].forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.addEventListener('keypress', soloNumeros);
                    campo.addEventListener('input', function() { limpiarLetras(this); });
                    campo.addEventListener('paste', function() { setTimeout(() => limpiarLetras(this), 10); });
                }
            });
        }, 100);
    }

    function validarFormulario(idExcluir = null) {
        const nombre = document.getElementById('swal-nombre').value.trim();
        const documento = document.getElementById('swal-documento').value.trim();
        const telefono = document.getElementById('swal-telefono').value.trim();
        const email = document.getElementById('swal-email').value.trim();
        const direccion = document.getElementById('swal-direccion').value.trim();
        const estado = document.getElementById('swal-estado').value;

        if (!nombre || !documento || !telefono || !email || !direccion) {
            Swal.showValidationMessage('Todos los campos son obligatorios'); return false;
        }
        if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(nombre)) {
            Swal.showValidationMessage('El nombre solo debe contener letras'); return false;
        }
        if (!/^\d+$/.test(documento)) {
            Swal.showValidationMessage('El documento solo debe contener números'); return false;
        }
        if (documento.length < 6 || documento.length > 12) {
            Swal.showValidationMessage('El documento debe tener entre 6 y 12 dígitos'); return false;
        }
        if (!/^\d+$/.test(telefono)) {
            Swal.showValidationMessage('El teléfono solo debe contener números'); return false;
        }
        if (telefono.length !== 10) {
            Swal.showValidationMessage('El teléfono debe tener 10 dígitos'); return false;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            Swal.showValidationMessage('Ingrese un email válido'); return false;
        }

        return { nombre, documento, telefono, email, direccion, estado };
    }

    function formularioHtml(c = null) {
        return `
            <div class="mb-3 text-start">
                <label class="form-label">Nombre completo</label>
                <input id="swal-nombre" class="form-control" placeholder="Ej: Juan Pérez" value="${c ? c.nombre : ''}">
            </div>
            <div class="mb-3 text-start">
                <label class="form-label">Documento</label>
                <input id="swal-documento" class="form-control" placeholder="Ej: 1234567890" maxlength="12" value="${c ? c.documento : ''}">
            </div>
            <div class="mb-3 text-start">
                <label class="form-label">Teléfono</label>
                <input id="swal-telefono" class="form-control" placeholder="Ej: 3001234567" maxlength="10" value="${c ? c.telefono : ''}">
            </div>
            <div class="mb-3 text-start">
                <label class="form-label">Email</label>
                <input id="swal-email" type="email" class="form-control" placeholder="Ej: cliente@email.com" value="${c ? c.email : ''}">
            </div>
            <div class="mb-3 text-start">
                <label class="form-label">Dirección</label>
                <input id="swal-direccion" class="form-control" placeholder="Ej: Calle 123 #45-67" value="${c ? c.direccion : ''}">
            </div>
            <div class="mb-3 text-start">
                <label class="form-label">Estado</label>
                <select id="swal-estado" class="form-select">
                    <option value="activo" ${!c || c.estado === 'activo' ? 'selected' : ''}>Activo</option>
                    <option value="inactivo" ${c && c.estado === 'inactivo' ? 'selected' : ''}>Inactivo</option>
                </select>
            </div>`;
    }

    // ===== AGREGAR CLIENTE =====
    async function agregarCliente() {
        const { value: formValues } = await Swal.fire({
            title: 'Agregar Nuevo Cliente',
            html: formularioHtml(),
            didOpen: () => aplicarValidacionesNumericas(),
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d',
            width: '600px',
            preConfirm: () => validarFormulario()
        });

        if (formValues) {
            fetch('/clientes/crear/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
                body: JSON.stringify(formValues)
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    Swal.fire({ title: '¡Registrado!', text: 'Cliente registrado correctamente', icon: 'success', confirmButtonColor: '#198754' });
                    cargarClientes();
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.error, confirmButtonColor: '#dc3545' });
                }
            });
        }
    }

    // ===== EDITAR CLIENTE =====
    async function editarCliente(id) {
        const cliente = clientes.find(c => c.id === id);
        if (!cliente) return;

        const { value: formValues } = await Swal.fire({
            title: 'Editar Cliente',
            html: formularioHtml(cliente),
            didOpen: () => aplicarValidacionesNumericas(),
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d',
            width: '600px',
            preConfirm: () => validarFormulario(id)
        });

        if (formValues) {
            fetch(`/clientes/editar/${id}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
                body: JSON.stringify(formValues)
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    Swal.fire({ title: '¡Actualizado!', text: 'Cliente actualizado correctamente', icon: 'success', confirmButtonColor: '#198754' });
                    cargarClientes();
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.error, confirmButtonColor: '#dc3545' });
                }
            });
        }
    }

    // ===== ELIMINAR CLIENTE =====
    function eliminarCliente(id) {
        const cliente = clientes.find(c => c.id === id);
        if (!cliente) return;

        Swal.fire({
            title: '¿Estás seguro?',
            text: `¿Deseas eliminar el cliente "${cliente.nombre}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then(result => {
            if (result.isConfirmed) {
                fetch(`/clientes/eliminar/${id}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': CSRF }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        Swal.fire({ title: '¡Eliminado!', text: 'Cliente eliminado correctamente', icon: 'success', confirmButtonColor: '#198754' });
                        cargarClientes();
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: data.error });
                    }
                });
            }
        });
    }

    document.getElementById('searchInputClientes').addEventListener('input', renderizarClientes);
    document.getElementById('filtroEstado').addEventListener('change', renderizarClientes);

    cargarClientes();
</script>

{% endblock %}