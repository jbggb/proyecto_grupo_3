{% extends 'base.html' %}
{% load static %}

{% block content %}

<h1 class="mb-4">Sistema de Clientes</h1>

<p class="text-muted">
    Sistema de inventario por el Grupo 3
</p>

<!-- ===== BOTÓN AGREGAR CLIENTE ===== -->
<div class="mb-3">
    <button type="button" class="btn btn-success" onclick="agregarCliente()">
        <i class="fa-solid fa-user-plus me-2"></i>Agregar Cliente
    </button>
</div>

<!-- ===== MENÚ SUPERIOR - BÚSQUEDA Y FILTROS ===== -->
<div class="card mb-3">
    <div class="card-body">
        <!-- Búsqueda -->
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" 
                       id="searchInputClientes" 
                       class="form-control" 
                       placeholder="Buscar cliente...">
            </div>
        </div>

        <!-- Filtros -->
        <div class="row">
            <div class="col-12">
                <label class="form-label">Filtrar por estado:</label>
                <select id="filtroEstado" class="form-select" style="max-width: 300px;">
                    <option value="all">Todos</option>
                    <option value="activo">Activos</option>
                    <option value="inactivo">Inactivos</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- ===== TABLA CLIENTES ===== -->
<div class="card mt-4">
    <div class="card-header bg-dark text-light">
        Clientes registrados
    </div>

    <div class="card-body">
        <table class="table table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Documento</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Dirección</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="clientesTabla">
                <!-- Los clientes se cargarán dinámicamente aquí -->
            </tbody>
        </table>
    </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script>
    // Datos de ejemplo de clientes
    let clientes = [
        { 
            id: 1, 
            nombre: "Juan Pérez", 
            documento: "1234567890",
            telefono: "3001234567",
            email: "juan.perez@email.com",
            direccion: "Calle 123 #45-67",
            estado: "activo"
        },
        { 
            id: 2, 
            nombre: "María González", 
            documento: "9876543210",
            telefono: "3109876543",
            email: "maria.gonzalez@email.com",
            direccion: "Carrera 45 #12-34",
            estado: "activo"
        },
        { 
            id: 3, 
            nombre: "Carlos Rodríguez", 
            documento: "5555555555",
            telefono: "3205555555",
            email: "carlos.rodriguez@email.com",
            direccion: "Avenida 78 #90-12",
            estado: "inactivo"
        },
        { 
            id: 4, 
            nombre: "Ana Martínez", 
            documento: "1111111111",
            telefono: "3151111111",
            email: "ana.martinez@email.com",
            direccion: "Diagonal 34 #56-78",
            estado: "activo"
        },
        { 
            id: 5, 
            nombre: "Pedro López", 
            documento: "2222222222",
            telefono: "3002222222",
            email: "pedro.lopez@email.com",
            direccion: "Transversal 90 #12-34",
            estado: "activo"
        }
    ];

    function renderizarClientes() {
        const tbody = document.getElementById('clientesTabla');
        const busqueda = document.getElementById('searchInputClientes').value.toLowerCase();
        const filtro = document.getElementById('filtroEstado').value;
        
        // Filtrar clientes
        let clientesFiltrados = clientes.filter(c => {
            // Búsqueda
            const cumpleBusqueda = c.nombre.toLowerCase().includes(busqueda) ||
                                   c.documento.includes(busqueda) ||
                                   c.email.toLowerCase().includes(busqueda);
            
            // Filtro de estado
            let cumpleFiltro = true;
            if (filtro === 'activo') cumpleFiltro = c.estado === 'activo';
            else if (filtro === 'inactivo') cumpleFiltro = c.estado === 'inactivo';
            
            return cumpleBusqueda && cumpleFiltro;
        });

        // Renderizar filas
        tbody.innerHTML = clientesFiltrados.map(c => `
            <tr>
                <td>${c.id}</td>
                <td>${c.nombre}</td>
                <td>${c.documento}</td>
                <td>${c.telefono}</td>
                <td>${c.email}</td>
                <td>${c.direccion}</td>
                <td>
                    <span class="badge ${c.estado === 'activo' ? 'bg-success' : 'bg-secondary'}">
                        ${c.estado === 'activo' ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td>
                    <button type="button" class="btn btn-primary btn-sm" onclick="editarCliente(${c.id})">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarCliente(${c.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // ===== FUNCIÓN AGREGAR CLIENTE =====
    async function agregarCliente() {
        const { value: formValues } = await Swal.fire({
            title: 'Agregar Nuevo Cliente',
            html: `
                <div class="mb-3 text-start">
                    <label class="form-label">Nombre completo</label>
                    <input id="swal-nombre" class="form-control" placeholder="Ej: Juan Pérez">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Documento</label>
                    <input id="swal-documento" class="form-control" placeholder="Ej: 1234567890" maxlength="12">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Teléfono</label>
                    <input id="swal-telefono" class="form-control" placeholder="Ej: 3001234567" maxlength="10">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Email</label>
                    <input id="swal-email" type="email" class="form-control" placeholder="Ej: cliente@email.com">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Dirección</label>
                    <input id="swal-direccion" class="form-control" placeholder="Ej: Calle 123 #45-67">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Estado</label>
                    <select id="swal-estado" class="form-select">
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d',
            width: '600px',
            preConfirm: () => {
                const nombre = document.getElementById('swal-nombre').value.trim();
                const documento = document.getElementById('swal-documento').value.trim();
                const telefono = document.getElementById('swal-telefono').value.trim();
                const email = document.getElementById('swal-email').value.trim();
                const direccion = document.getElementById('swal-direccion').value.trim();
                const estado = document.getElementById('swal-estado').value;

                // Validar campos vacíos
                if (!nombre || !documento || !telefono || !email || !direccion) {
                    Swal.showValidationMessage('Todos los campos son obligatorios');
                    return false;
                }

                // Validar que el nombre solo contenga letras y espacios
                const regexNombre = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
                if (!regexNombre.test(nombre)) {
                    Swal.showValidationMessage('El nombre solo debe contener letras');
                    return false;
                }

                // Validar que el documento solo contenga números
                const regexDocumento = /^\d+$/;
                if (!regexDocumento.test(documento)) {
                    Swal.showValidationMessage('El documento solo debe contener números');
                    return false;
                }

                // Validar longitud del documento (entre 6 y 12 dígitos)
                if (documento.length < 6 || documento.length > 12) {
                    Swal.showValidationMessage('El documento debe tener entre 6 y 12 dígitos');
                    return false;
                }

                // Validar que el documento no esté duplicado
                const documentoDuplicado = clientes.some(c => c.documento === documento);
                if (documentoDuplicado) {
                    Swal.showValidationMessage('Ya existe un cliente con este número de documento');
                    return false;
                }

                // Validar que el teléfono solo contenga números
                const regexTelefono = /^\d+$/;
                if (!regexTelefono.test(telefono)) {
                    Swal.showValidationMessage('El teléfono solo debe contener números');
                    return false;
                }

                // Validar longitud del teléfono (10 dígitos para Colombia)
                if (telefono.length !== 10) {
                    Swal.showValidationMessage('El teléfono debe tener 10 dígitos');
                    return false;
                }

                // Validar formato de email
                const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!regexEmail.test(email)) {
                    Swal.showValidationMessage('Ingrese un email válido');
                    return false;
                }

                // Validar que el email no esté duplicado
                const emailDuplicado = clientes.some(c => c.email.toLowerCase() === email.toLowerCase());
                if (emailDuplicado) {
                    Swal.showValidationMessage('Ya existe un cliente con este email');
                    return false;
                }

                return {
                    nombre,
                    documento,
                    telefono,
                    email,
                    direccion,
                    estado
                }
            }
        });

        if (formValues) {
            // Generar nuevo ID
            const nuevoId = clientes.length > 0 ? Math.max(...clientes.map(c => c.id)) + 1 : 1;
            
            // Agregar el nuevo cliente
            clientes.push({
                id: nuevoId,
                ...formValues
            });

            // Mostrar mensaje de éxito
            Swal.fire({
                title: '¡Registrado!',
                text: 'El cliente ha sido registrado correctamente',
                icon: 'success',
                confirmButtonColor: '#198754'
            });

            // Actualizar la tabla
            renderizarClientes();
        }
    }

    // ===== FUNCIÓN EDITAR CLIENTE =====
    async function editarCliente(id) {
        const cliente = clientes.find(c => c.id === id);
        
        if (!cliente) return;

        const { value: formValues } = await Swal.fire({
            title: 'Editar Cliente',
            html: `
                <div class="mb-3 text-start">
                    <label class="form-label">Nombre completo</label>
                    <input id="swal-nombre" class="form-control" value="${cliente.nombre}">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Documento</label>
                    <input id="swal-documento" class="form-control" value="${cliente.documento}" maxlength="12">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Teléfono</label>
                    <input id="swal-telefono" class="form-control" value="${cliente.telefono}" maxlength="10">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Email</label>
                    <input id="swal-email" type="email" class="form-control" value="${cliente.email}">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Dirección</label>
                    <input id="swal-direccion" class="form-control" value="${cliente.direccion}">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Estado</label>
                    <select id="swal-estado" class="form-select">
                        <option value="activo" ${cliente.estado === 'activo' ? 'selected' : ''}>Activo</option>
                        <option value="inactivo" ${cliente.estado === 'inactivo' ? 'selected' : ''}>Inactivo</option>
                    </select>
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d',
            width: '600px',
            preConfirm: () => {
                const nombre = document.getElementById('swal-nombre').value.trim();
                const documento = document.getElementById('swal-documento').value.trim();
                const telefono = document.getElementById('swal-telefono').value.trim();
                const email = document.getElementById('swal-email').value.trim();
                const direccion = document.getElementById('swal-direccion').value.trim();
                const estado = document.getElementById('swal-estado').value;

                // Validar campos vacíos
                if (!nombre || !documento || !telefono || !email || !direccion) {
                    Swal.showValidationMessage('Todos los campos son obligatorios');
                    return false;
                }

                // Validar que el nombre solo contenga letras y espacios
                const regexNombre = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
                if (!regexNombre.test(nombre)) {
                    Swal.showValidationMessage('El nombre solo debe contener letras');
                    return false;
                }

                // Validar que el documento solo contenga números
                const regexDocumento = /^\d+$/;
                if (!regexDocumento.test(documento)) {
                    Swal.showValidationMessage('El documento solo debe contener números');
                    return false;
                }

                // Validar longitud del documento (entre 6 y 12 dígitos)
                if (documento.length < 6 || documento.length > 12) {
                    Swal.showValidationMessage('El documento debe tener entre 6 y 12 dígitos');
                    return false;
                }

                // Validar que el documento no esté duplicado (excepto el actual)
                const documentoDuplicado = clientes.some(c => c.id !== id && c.documento === documento);
                if (documentoDuplicado) {
                    Swal.showValidationMessage('Ya existe otro cliente con este número de documento');
                    return false;
                }

                // Validar que el teléfono solo contenga números
                const regexTelefono = /^\d+$/;
                if (!regexTelefono.test(telefono)) {
                    Swal.showValidationMessage('El teléfono solo debe contener números');
                    return false;
                }

                // Validar longitud del teléfono (10 dígitos para Colombia)
                if (telefono.length !== 10) {
                    Swal.showValidationMessage('El teléfono debe tener 10 dígitos');
                    return false;
                }

                // Validar formato de email
                const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!regexEmail.test(email)) {
                    Swal.showValidationMessage('Ingrese un email válido');
                    return false;
                }

                // Validar que el email no esté duplicado (excepto el actual)
                const emailDuplicado = clientes.some(c => c.id !== id && c.email.toLowerCase() === email.toLowerCase());
                if (emailDuplicado) {
                    Swal.showValidationMessage('Ya existe otro cliente con este email');
                    return false;
                }

                return {
                    nombre,
                    documento,
                    telefono,
                    email,
                    direccion,
                    estado
                }
            }
        });

        if (formValues) {
            // Actualizar el cliente
            const index = clientes.findIndex(c => c.id === id);
            clientes[index] = {
                ...clientes[index],
                ...formValues
            };

            // Mostrar mensaje de éxito
            Swal.fire({
                title: '¡Actualizado!',
                text: 'El cliente ha sido actualizado correctamente',
                icon: 'success',
                confirmButtonColor: '#198754'
            });

            // Actualizar la tabla
            renderizarClientes();
        }
    }

    // ===== FUNCIÓN ELIMINAR CLIENTE =====
    function eliminarCliente(id) {
        const cliente = clientes.find(c => c.id === id);
        
        if (!cliente) return;

        Swal.fire({
            title: '¿Estás seguro?',
            text: `¿Deseas eliminar el cliente "${cliente.nombre}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                // Eliminar el cliente del array
                clientes = clientes.filter(c => c.id !== id);

                // Mostrar mensaje de éxito
                Swal.fire({
                    title: '¡Eliminado!',
                    text: 'El cliente ha sido eliminado correctamente',
                    icon: 'success',
                    confirmButtonColor: '#198754'
                });

                // Actualizar la tabla
                renderizarClientes();
            }
        });
    }

    // Eventos
    document.getElementById('searchInputClientes').addEventListener('input', renderizarClientes);
    document.getElementById('filtroEstado').addEventListener('change', renderizarClientes);

    // Cargar clientes al iniciar
    renderizarClientes();
</script>

{% endblock %}