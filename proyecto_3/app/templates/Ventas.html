{% extends 'base.html' %}

{% block content %}

<!-- Stats Cards -->
<h2 class="mb-4"><i class="fa-solid fa-cart-shopping me-2"></i>Panel de GestiÃ³n de Ventas</h2>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm border-start border-primary border-3">
            <div class="card-body">
                <h6 class="text-muted">Ventas de Hoy</h6>
                <h3 id="ventasHoy">$0</h3>
                <small class="text-success"><i class="fa-solid fa-arrow-up"></i> 12% vs ayer</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm border-start border-primary border-3">
            <div class="card-body">
                <h6 class="text-muted">Total Mes</h6>
                <h3 id="totalMes">$0</h3>
                <small class="text-success"><i class="fa-solid fa-arrow-up"></i> 8% vs mes anterior</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm border-start border-primary border-3">
            <div class="card-body">
                <h6 class="text-muted">Ventas Realizadas</h6>
                <h3 id="totalVentasCount">0</h3>
                <small class="text-muted">Este mes</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm border-start border-primary border-3">
            <div class="card-body">
                <h6 class="text-muted">Ticket Promedio</h6>
                <h3 id="ticketPromedio">$0</h3>
                <small class="text-info"><i class="fa-solid fa-minus"></i> Sin cambios</small>
            </div>
        </div>
    </div>
</div>

<!-- BÃºsqueda y filtros -->
<div class="card border-0 shadow-sm">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="buscarVenta" class="form-control" placeholder="Buscar venta...">
            </div>
            <div class="col-md-3">
                <select id="filtroFecha" class="form-select">
                    <option value="todas">Filtrar por fecha</option>
                    <option value="hoy">Hoy</option>
                    <option value="semana">Esta semana</option>
                    <option value="mes">Este mes</option>
                    <option value="todas">Todas</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="nuevaVenta()">
                    <i class="fa-solid fa-plus me-1"></i> Nueva Venta
                </button>
            </div>
        </div>

        <!-- Tabla -->
        <h5 class="bg-dark text-white p-2 mb-0">VENTAS REGISTRADAS</h5>
        <table class="table table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Productos</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>AcciÃ³n</th>
                </tr>
            </thead>
            <tbody id="ventasTableBody">
                <tr>
                    <td>1</td><td>05/02/2026 10:30</td><td>Juan PÃ©rez</td>
                    <td>Harina, Queso</td><td>$30.000</td>
                    <td><span class="badge bg-success">Completada</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="verDetalle(1,'Juan PÃ©rez','Harina, Queso','$30.000','05/02/2026 10:30')"><i class="fa-solid fa-eye"></i></button>
                        <button class="btn btn-info btn-sm" onclick="imprimirVenta(1)"><i class="fa-solid fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarVenta(this,1,'Juan PÃ©rez')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                <tr>
                    <td>2</td><td>05/02/2026 11:45</td><td>MarÃ­a GarcÃ­a</td>
                    <td>Jabon Axion</td><td>$16.000</td>
                    <td><span class="badge bg-success">Completada</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="verDetalle(2,'MarÃ­a GarcÃ­a','Jabon Axion','$16.000','05/02/2026 11:45')"><i class="fa-solid fa-eye"></i></button>
                        <button class="btn btn-info btn-sm" onclick="imprimirVenta(2)"><i class="fa-solid fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarVenta(this,2,'MarÃ­a GarcÃ­a')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                <tr>
                    <td>3</td><td>05/02/2026 14:20</td><td>Carlos RodrÃ­guez</td>
                    <td>Queso, Harina, Jabon</td><td>$38.000</td>
                    <td><span class="badge bg-warning text-dark">Pendiente</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="verDetalle(3,'Carlos RodrÃ­guez','Queso, Harina, Jabon','$38.000','05/02/2026 14:20')"><i class="fa-solid fa-eye"></i></button>
                        <button class="btn btn-info btn-sm" onclick="imprimirVenta(3)"><i class="fa-solid fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarVenta(this,3,'Carlos RodrÃ­guez')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                <tr>
                    <td>4</td><td>04/02/2026 16:10</td><td>Ana MartÃ­nez</td>
                    <td>Harina</td><td>$10.000</td>
                    <td><span class="badge bg-success">Completada</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="verDetalle(4,'Ana MartÃ­nez','Harina','$10.000','04/02/2026 16:10')"><i class="fa-solid fa-eye"></i></button>
                        <button class="btn btn-info btn-sm" onclick="imprimirVenta(4)"><i class="fa-solid fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarVenta(this,4,'Ana MartÃ­nez')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    actualizarEstadisticas();

    document.getElementById('buscarVenta').addEventListener('input', function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll('#ventasTableBody tr').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
        actualizarEstadisticas();
    });

    document.getElementById('filtroFecha').addEventListener('change', function() {
        const filter = this.value;
        const hoy = new Date();
        document.querySelectorAll('#ventasTableBody tr').forEach(row => {
            const [dia, mes, anio] = row.children[1].textContent.split(' ')[0].split('/');
            const fechaVenta = new Date(anio, mes - 1, dia);
            let mostrar = true;
            if (filter === 'hoy') mostrar = fechaVenta.toDateString() === hoy.toDateString();
            else if (filter === 'semana') {
                const inicio = new Date(hoy); inicio.setDate(hoy.getDate() - hoy.getDay());
                const fin = new Date(inicio); fin.setDate(inicio.getDate() + 6);
                mostrar = fechaVenta >= inicio && fechaVenta <= fin;
            } else if (filter === 'mes') mostrar = fechaVenta.getMonth() === hoy.getMonth();
            row.style.display = mostrar ? '' : 'none';
        });
        actualizarEstadisticas();
    });
});

function actualizarEstadisticas() {
    const filas = [...document.querySelectorAll('#ventasTableBody tr')].filter(r => r.style.display !== 'none');
    const hoy = new Date().toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', year:'numeric'});
    let totalMes = 0, ventasHoy = 0;
    filas.forEach(fila => {
        const total = parseFloat(fila.children[4].textContent.replace('$','').replace(/\./g,'').replace(',','')) || 0;
        totalMes += total;
        if (fila.children[1].textContent.split(' ')[0] === hoy) ventasHoy += total;
    });
    document.getElementById('ventasHoy').textContent = '$' + ventasHoy.toLocaleString('es-CO');
    document.getElementById('totalMes').textContent = '$' + totalMes.toLocaleString('es-CO');
    document.getElementById('totalVentasCount').textContent = filas.length;
    document.getElementById('ticketPromedio').textContent = '$' + (filas.length ? Math.round(totalMes / filas.length) : 0).toLocaleString('es-CO');
}

function verDetalle(id, cliente, productos, total, fecha) {
    Swal.fire({
        title: `Detalle de Venta #${id}`,
        html: `<div style="text-align:left;padding:10px;">
            <p><strong>ðŸ“… Fecha:</strong> ${fecha}</p>
            <p><strong>ðŸ‘¤ Cliente:</strong> ${cliente}</p>
            <p><strong>ðŸ“¦ Productos:</strong> ${productos}</p>
            <p><strong>ðŸ’° Total:</strong> ${total}</p>
        </div>`,
        icon: 'info', confirmButtonText: 'Cerrar', confirmButtonColor: '#007bff'
    });
}

function imprimirVenta(id) {
    Swal.fire({
        title: 'Â¿Imprimir factura?', text: `Â¿Deseas imprimir la factura de la venta #${id}?`,
        icon: 'question', showCancelButton: true,
        confirmButtonColor: '#17a2b8', cancelButtonColor: '#6c757d',
        confirmButtonText: 'SÃ­, imprimir', cancelButtonText: 'Cancelar'
    }).then(r => {
        if (r.isConfirmed) Swal.fire({ title: 'Â¡Imprimiendo!', text: `Factura #${id} enviada a impresora`, icon: 'success', timer: 2000, showConfirmButton: false });
    });
}

function eliminarVenta(btn, id, cliente) {
    Swal.fire({
        title: 'Â¿EstÃ¡s seguro?', text: `Â¿Deseas eliminar la venta de ${cliente}?`,
        icon: 'warning', showCancelButton: true,
        confirmButtonColor: '#dc3545', cancelButtonColor: '#6c757d',
        confirmButtonText: 'SÃ­, eliminar', cancelButtonText: 'Cancelar'
    }).then(r => {
        if (r.isConfirmed) {
            const fila = btn.closest('tr');
            fila.style.transition = 'opacity 0.5s';
            fila.style.opacity = '0';
            setTimeout(() => { fila.remove(); actualizarEstadisticas();
                Swal.fire({ title: 'Â¡Eliminada!', text: `Venta #${id} eliminada`, icon: 'success', timer: 2000, showConfirmButton: false });
            }, 500);
        }
    });
}

function nuevaVenta() {
    Swal.fire({
        title: 'Nueva Venta',
        html: `<div style="text-align:left;">
            <label class="form-label">Cliente</label>
            <input id="clienteVenta" class="form-control mb-2" placeholder="Nombre del cliente">
            <label class="form-label">Productos</label>
            <input id="productosVenta" class="form-control mb-2" placeholder="Ej: Harina, Queso">
            <label class="form-label">Total</label>
            <input type="number" id="totalVenta" class="form-control mb-2" placeholder="0">
            <label class="form-label">Estado</label>
            <select id="estadoVenta" class="form-select">
                <option value="Completada">Completada</option>
                <option value="Pendiente">Pendiente</option>
            </select>
        </div>`,
        showCancelButton: true, confirmButtonColor: '#28a745', cancelButtonColor: '#6c757d',
        confirmButtonText: 'Guardar', cancelButtonText: 'Cancelar', width: '500px',
        preConfirm: () => {
            const c = document.getElementById('clienteVenta').value;
            const p = document.getElementById('productosVenta').value;
            const t = document.getElementById('totalVenta').value;
            if (!c || !p || !t) { Swal.showValidationMessage('Completa todos los campos'); return false; }
            return { cliente: c, productos: p, total: t, estado: document.getElementById('estadoVenta').value };
        }
    }).then(r => {
        if (r.isConfirmed) {
            const { cliente, productos, total, estado } = r.value;
            const ahora = new Date();
            const fecha = `${String(ahora.getDate()).padStart(2,'0')}/${String(ahora.getMonth()+1).padStart(2,'0')}/${ahora.getFullYear()} ${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;
            const tbody = document.getElementById('ventasTableBody');
            const ultimoId = tbody.querySelector('tr:last-child') ? parseInt(tbody.querySelector('tr:last-child td').textContent) : 0;
            const nuevoId = ultimoId + 1;
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td>${nuevoId}</td><td>${fecha}</td><td>${cliente}</td><td>${productos}</td>
                <td>$${parseFloat(total).toLocaleString('es-CO')}</td>
                <td><span class="badge bg-${estado === 'Completada' ? 'success' : 'warning text-dark'}">${estado}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="verDetalle(${nuevoId},'${cliente}','${productos}','$${parseFloat(total).toLocaleString('es-CO')}','${fecha}')"><i class="fa-solid fa-eye"></i></button>
                    <button class="btn btn-info btn-sm" onclick="imprimirVenta(${nuevoId})"><i class="fa-solid fa-print"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarVenta(this,${nuevoId},'${cliente}')"><i class="fa-solid fa-trash"></i></button>
                </td>`;
            fila.style.opacity = '0'; fila.style.transition = 'opacity 0.5s';
            tbody.appendChild(fila);
            setTimeout(() => { fila.style.opacity = '1'; actualizarEstadisticas(); }, 100);
            Swal.fire({ title: 'Â¡Venta registrada!', text: `Venta #${nuevoId} registrada`, icon: 'success', timer: 2000, showConfirmButton: false });
        }
    });
}
</script>

{% endblock %}