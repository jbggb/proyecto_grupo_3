{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>GestiÃ³n de Compras</h1>
        <p class="text-muted mb-0">Sistema de inventario por el Grupo 3</p>
    </div>
    <button class="btn btn-success" onclick="agregarCompra()">
        ðŸ›’ Agregar Compra
    </button>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <input type="text" class="form-control" placeholder="Buscar por proveedor o producto..." id="inputBuscar">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="selEstado">
                    <option value="">Todos los estados</option>
                    <option value="true">Completada</option>
                    <option value="false">Pendiente</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Tabla -->
<div class="card">
    <div class="card-header bg-dark text-white">Compras registradas</div>
    <div class="card-body p-0">
        <table class="table table-bordered table-hover mb-0" id="tablaCompras">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Proveedor</th>
                    <th>Producto</th>
                    <th>Administrador</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tbodyCompras"></tbody>
        </table>
    </div>
</div>

<script>
const CSRF = '{{ csrf_token }}';
let compras = [];
let proveedores = [];
let productos = [];
let administradores = [];

async function cargarDatos() {
    const [rCompras, rProveedores, rProductos] = await Promise.all([
        fetch('/compras/json/').then(r => r.json()),
        fetch('/proveedores/json/').then(r => r.json()),
        fetch('/productos/json/').then(r => r.json()),
    ]);
    compras = rCompras.compras;
    proveedores = rProveedores.proveedores;
    productos = rProductos.productos;
    renderizarCompras();
}

function opcionesProveedores(selId = '') {
    return proveedores.map(p => `<option value="${p.id}" ${p.id == selId ? 'selected' : ''}>${p.nombre}</option>`).join('');
}

function opcionesProductos(selId = '') {
    return productos.map(p => `<option value="${p.id}" ${p.id == selId ? 'selected' : ''}>${p.nombre}</option>`).join('');
}

function renderizarCompras() {
    const tbody = document.getElementById('tbodyCompras');
    const busqueda = document.getElementById('inputBuscar').value.toLowerCase();
    const filtroEstado = document.getElementById('selEstado').value;

    let filtradas = compras.filter(c => {
        const cumpleBusqueda = c.proveedor.toLowerCase().includes(busqueda) ||
                               c.producto.toLowerCase().includes(busqueda);
        const cumpleEstado = filtroEstado === '' || String(c.estado) === filtroEstado;
        return cumpleBusqueda && cumpleEstado;
    });

    if (filtradas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">No hay compras registradas</td></tr>`;
        return;
    }

    tbody.innerHTML = filtradas.map(c => `
        <tr>
            <td>${c.id}</td>
            <td>${c.proveedor}</td>
            <td>${c.producto}</td>
            <td>${c.administrador}</td>
            <td>${c.fecha}</td>
            <td>
                <span class="badge ${c.estado ? 'bg-success' : 'bg-warning text-dark'}">
                    ${c.estado ? 'Completada' : 'Pendiente'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editarCompra(${c.id})">
                    <i class="fa-solid fa-pen"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="eliminarCompra(${c.id})">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function formularioHtml(c = null) {
    return `
        <div class="mb-3 text-start">
            <label class="form-label">Proveedor <span class="text-danger">*</span></label>
            <select id="swal-proveedor" class="form-select">
                <option value="">â€” Seleccionar â€”</option>
                ${opcionesProveedores(c ? c.proveedor_id : '')}
            </select>
        </div>
        <div class="mb-3 text-start">
            <label class="form-label">Producto <span class="text-danger">*</span></label>
            <select id="swal-producto" class="form-select">
                <option value="">â€” Seleccionar â€”</option>
                ${opcionesProductos(c ? c.producto_id : '')}
            </select>
        </div>
        <div class="mb-3 text-start">
            <label class="form-label">Fecha <span class="text-danger">*</span></label>
            <input id="swal-fecha" type="date" class="form-control" value="${c ? c.fecha : ''}">
        </div>
        <div class="mb-3 text-start">
            <label class="form-label">Estado</label>
            <select id="swal-estado" class="form-select">
                <option value="false" ${!c || !c.estado ? 'selected' : ''}>Pendiente</option>
                <option value="true" ${c && c.estado ? 'selected' : ''}>Completada</option>
            </select>
        </div>`;
}

function validarFormulario() {
    const proveedor_id = document.getElementById('swal-proveedor').value;
    const producto_id = document.getElementById('swal-producto').value;
    const fecha = document.getElementById('swal-fecha').value;
    const estado = document.getElementById('swal-estado').value === 'true';
    if (!proveedor_id || !producto_id || !fecha) {
        Swal.showValidationMessage('Proveedor, producto y fecha son obligatorios'); return false;
    }
    return { proveedor_id: parseInt(proveedor_id), producto_id: parseInt(producto_id), fecha, estado };
}

async function agregarCompra() {
    const { value: data } = await Swal.fire({
        title: 'Nueva Compra',
        html: formularioHtml(),
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#198754',
        width: '550px',
        focusConfirm: false,
        preConfirm: validarFormulario
    });
    if (!data) return;
    const resp = await fetch('/compras/crear/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
        body: JSON.stringify(data)
    }).then(r => r.json());
    if (resp.ok) {
        Swal.fire({ title: 'Â¡Registrada!', text: 'Compra registrada correctamente', icon: 'success', confirmButtonColor: '#198754' });
        cargarDatos();
    } else {
        Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
    }
}

async function editarCompra(id) {
    const c = compras.find(x => x.id === id);
    if (!c) return;
    const { value: data } = await Swal.fire({
        title: 'Editar Compra',
        html: formularioHtml(c),
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#0d6efd',
        width: '550px',
        focusConfirm: false,
        preConfirm: validarFormulario
    });
    if (!data) return;
    const resp = await fetch(`/compras/editar/${id}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
        body: JSON.stringify(data)
    }).then(r => r.json());
    if (resp.ok) {
        Swal.fire({ title: 'Â¡Actualizada!', text: 'Compra actualizada correctamente', icon: 'success', confirmButtonColor: '#198754' });
        cargarDatos();
    } else {
        Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
    }
}

function eliminarCompra(id) {
    Swal.fire({
        title: 'Â¿EstÃ¡s seguro?',
        text: 'Â¿Deseas eliminar esta compra?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'SÃ­, eliminar',
        cancelButtonText: 'Cancelar'
    }).then(async result => {
        if (result.isConfirmed) {
            const resp = await fetch(`/compras/eliminar/${id}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF }
            }).then(r => r.json());
            if (resp.ok) {
                Swal.fire({ title: 'Â¡Eliminada!', icon: 'success', timer: 2000, showConfirmButton: false });
                cargarDatos();
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
            }
        }
    });
}

document.getElementById('inputBuscar').addEventListener('input', renderizarCompras);
document.getElementById('selEstado').addEventListener('change', renderizarCompras);

cargarDatos();
</script>

{% endblock %}