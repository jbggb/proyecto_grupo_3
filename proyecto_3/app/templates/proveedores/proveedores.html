{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fa-solid fa-truck me-2"></i>Gestión de Proveedores</h2>
    <button class="btn btn-success" onclick="agregarProveedor()">
        <i class="fa-solid fa-plus me-1"></i> Nuevo Proveedor
    </button>
</div>

<!-- Búsqueda -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <input type="text" id="buscarProveedor" class="form-control" placeholder="Buscar por nombre, email o teléfono...">
            </div>
        </div>
    </div>
</div>

<!-- Tabla -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-dark text-white">
        <i class="fa-solid fa-list me-2"></i>Proveedores Registrados
    </div>
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Envío (días)</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaProveedores"></tbody>
        </table>
    </div>
</div>

<script>
const CSRF = '{{ csrf_token }}';
let proveedores = [];

function cargarProveedores() {
    fetch('/proveedores/json/')
        .then(r => r.json())
        .then(data => {
            proveedores = data.proveedores;
            renderizarProveedores();
        })
        .catch(() => Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudieron cargar los proveedores.' }));
}

function renderizarProveedores() {
    const tbody = document.getElementById('tablaProveedores');
    const busqueda = document.getElementById('buscarProveedor').value.toLowerCase();

    let filtrados = proveedores.filter(p =>
        p.nombre.toLowerCase().includes(busqueda) ||
        p.email.toLowerCase().includes(busqueda) ||
        p.telefono.includes(busqueda)
    );

    if (filtrados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">No hay proveedores registrados</td></tr>`;
        return;
    }

    tbody.innerHTML = filtrados.map(p => `
        <tr>
            <td>${p.id}</td>
            <td><strong>${p.nombre}</strong></td>
            <td>${p.telefono}</td>
            <td>${p.email}</td>
            <td>${p.envio}</td>
            <td>${p.fechaRegistro}</td>
            <td>
                <button class="btn btn-primary btn-sm me-1" onclick="editarProveedor(${p.id})">
                    <i class="fa-solid fa-pen"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="eliminarProveedor(${p.id})">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function formularioHtml(p = null) {
    return `
        <div class="mb-3 text-start">
            <label class="form-label">Nombre <span class="text-danger">*</span></label>
            <input id="swal-nombre" class="form-control" placeholder="Nombre del proveedor" value="${p ? p.nombre : ''}">
        </div>
        <div class="mb-3 text-start">
            <label class="form-label">Teléfono <span class="text-danger">*</span></label>
            <input id="swal-telefono" class="form-control" placeholder="3001234567" maxlength="20" value="${p ? p.telefono : ''}">
        </div>
        <div class="mb-3 text-start">
            <label class="form-label">Email <span class="text-danger">*</span></label>
            <input id="swal-email" type="email" class="form-control" placeholder="proveedor@email.com" value="${p ? p.email : ''}">
        </div>
        <div class="mb-3 text-start">
            <label class="form-label">Días de envío</label>
            <input id="swal-envio" type="number" class="form-control" placeholder="0" min="0" value="${p ? p.envio : 0}">
        </div>`;
}

function validarFormulario() {
    const nombre = document.getElementById('swal-nombre').value.trim();
    const telefono = document.getElementById('swal-telefono').value.trim();
    const email = document.getElementById('swal-email').value.trim();
    const envio = document.getElementById('swal-envio').value;
    if (!nombre || !telefono || !email) {
        Swal.showValidationMessage('Nombre, teléfono y email son obligatorios'); return false;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        Swal.showValidationMessage('Ingrese un email válido'); return false;
    }
    return { nombre, telefono, email, envio: parseInt(envio) || 0 };
}

async function agregarProveedor() {
    const { value: data } = await Swal.fire({
        title: 'Nuevo Proveedor',
        html: formularioHtml(),
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#198754',
        width: '550px',
        focusConfirm: false,
        preConfirm: validarFormulario
    });
    if (!data) return;
    const resp = await fetch('/proveedores/crear/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
        body: JSON.stringify(data)
    }).then(r => r.json());
    if (resp.ok) {
        Swal.fire({ title: '¡Registrado!', text: 'Proveedor agregado correctamente', icon: 'success', confirmButtonColor: '#198754' });
        cargarProveedores();
    } else {
        Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
    }
}

async function editarProveedor(id) {
    const p = proveedores.find(x => x.id === id);
    if (!p) return;
    const { value: data } = await Swal.fire({
        title: 'Editar Proveedor',
        html: formularioHtml(p),
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#0d6efd',
        width: '550px',
        focusConfirm: false,
        preConfirm: validarFormulario
    });
    if (!data) return;
    const resp = await fetch(`/proveedores/editar/${id}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
        body: JSON.stringify(data)
    }).then(r => r.json());
    if (resp.ok) {
        Swal.fire({ title: '¡Actualizado!', text: 'Proveedor actualizado correctamente', icon: 'success', confirmButtonColor: '#198754' });
        cargarProveedores();
    } else {
        Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
    }
}

function eliminarProveedor(id) {
    const p = proveedores.find(x => x.id === id);
    if (!p) return;
    Swal.fire({
        title: '¿Estás seguro?',
        text: `¿Eliminar al proveedor "${p.nombre}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then(async result => {
        if (result.isConfirmed) {
            const resp = await fetch(`/proveedores/eliminar/${id}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF }
            }).then(r => r.json());
            if (resp.ok) {
                Swal.fire({ title: '¡Eliminado!', icon: 'success', timer: 2000, showConfirmButton: false });
                cargarProveedores();
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
            }
        }
    });
}

document.getElementById('buscarProveedor').addEventListener('input', renderizarProveedores);
cargarProveedores();
</script>

{% endblock %}